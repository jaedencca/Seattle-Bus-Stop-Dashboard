// AI Usage disclosure: Generative AI was used to assist in debugging the chart rendering and filtering.
// AI was not used to generate any code, and all code choices can be explained by me.
// The code was tweaked and based on the original Lab 6 code.

<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Seattle Bus Stop Dashboard</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://fonts.googleapis.com/css?family=Titillium+Web|Oswald" rel="stylesheet">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.8.1/mapbox-gl.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/c3.min.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Titillium Web', serif;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        #info {
            z-index: 1000;
            position: absolute;
            width: 500px;
            top: 1%;
            bottom: 1%;
            left: .5%;
            padding: 40px 15px 900px 15px;
            background: #343a40;
            color: white;

        }


        /* social media icons */
        #info a {
            color: lightgray;
        }

        #info a:hover {
            color: white;
            opacity: 0.3;
        }


        #title {
            font-size: 25px;
            font-family: 'Oswald', sans-serif;
        }

        /* social media icons */
        #title span {
            font-size: 14px;
            float: right;
            margin-right: 10px;
        }


        #desc {
            text-align: center;
            color: lightgray;
            font-size: medium;
            font-weight: bold;
            margin-bottom: 0px;
        }

        #bus-count {
            margin: 0;
            text-align: center;
            color: orange;
            font-size: 50px;
        }

        #bus-chart {
            top: 20px;
        }


        #footer {
            position: absolute;
            bottom: 0px;
            margin-bottom: 20px;
            margin-right: 10px;
            font-size: 13px;
            line-height: 150%;
            color: lightgray;
        }

        /* the layout of the legend panel */
        #legend {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 110px;
            background: #343a40;
            margin-right: 20px;
            margin-bottom: 40px;
            padding: 10px 20px 10px 10px;
            border-radius: 3px;
            text-align: center;
            font-family: 'Titillium Web', sans-serif;
            color: white;
        }

        /* each line for a break */
        .break {
            position: relative;
            margin: 0px;
            padding: 0px 0px 10px 0px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* basic style for a dot/circle */
        .dot {
            display: inline-block;
            margin-top: 5px;
            border-radius: 50%;
            opacity: 0.6;
        }

        /* the label for the dot */
        .dot-label {
            position: static;
            font-style: italic;
            color: white;
            margin-top: 5px;
        }
    </style>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.8.1/mapbox-gl.js"></script>
    <script src="js/d3.js"></script>
    <script src="js/c3.min.js"></script>
</head>

<body>
    <div id="info">
        <div id="title">
            Seattle Bus Stop Dashboard
            <span id="reset"><a href="#">reset</a></span>
        </div>
        <div id="count" class="card">
            <h5 id="desc"> # Bus Stops in the displaying region</h5>
            <p id="bus-count"></p>
        </div>
        <h6 style="margin: 20px 0 10px 0; text-align: center; color: lightgray; font-weight: bold; font-size: 14px;">Distribution of Line Headings</h6>
        <div id="bearing-chart"></div>

        <div id="footer">
            This dashboard shows bus stop locations in Seattle, showing clusters of stops and their heading directions.
            <br><br>
            <strong>Data Source:</strong><br>
            <a href="https://services.arcgis.com/Ej0PsM5Aw677QF1W/arcgis/rest/services/TRANSITSTOP_POINT_2648/FeatureServer/0" target="_blank">ArcGIS Transit Stop Data</a>
        </div>
    </div>
    <div id="map"></div>
    <div id="legend"></div>
    <script>
        // assign the access token
        mapboxgl.accessToken =
            'pk.eyJ1IjoiamFlZGVuY2NhIiwiYSI6ImNtaGM4cDNxdDI3cHkya3B1emRxYzJuNWQifQ.GD3_Rhp6YQw5CkRSFClT0w';

        // declare the map object
        let map = new mapboxgl.Map({
            container: 'map', // container ID
            style: 'mapbox://styles/mapbox/dark-v10',
            zoom: 12, // starting zoom
            minZoom: 10,
            center: [-122.3321, 47.6062] // Seattle center
        });

        // declare the coordinated chart as well as other variables.
        let numBusStops = 0,
            bearingChart = null;

        // create a few constant variables
        const grades = [50, 100, 250, 500, 1000],
            colors = ['rgb(240,200,0)', 'rgb(230,130,0)', 'rgb(210,60,0)', 'rgb(170,0,0)', 'rgb(100,0,0)'],
            radii = [15, 20, 25, 30, 35];

        // create the legend object and anchor it to the html element with id legend.
        const legend = document.getElementById('legend');

        //set up legend grades content and labels
        let labels = ['<strong>Cluster Size</strong>'],
            vbreak;

        //iterate through grades and create a scaled circle and label for each
        for (var i = 0; i < grades.length; i++) {
            vbreak = grades[i];
            // you need to manually adjust the radius of each dot on the legend 
            // in order to make sure the legend can be properly referred to the dot on the map.
            dot_radii = 2 * radii[i];
            let label = '';
            if (i === 0) label = '50 or less';
            else if (i === 1) label = '50-100';
            else if (i === 2) label = '100-250';
            else if (i === 3) label = '250-500';
            else if (i === 4) label = '500+';
            labels.push(
                '<p class="break"><i class="dot" style="background:' + colors[i] + '; width: ' + dot_radii +
                'px; height: ' +
                dot_radii + 'px; "></i> <span class="dot-label">' + label +
                ' stops</span></p>');

        }

        // join all the labels and the source to create the legend content.
        legend.innerHTML = labels.join('');



        // define the asynchronous function to load geojson data.
        async function geojsonFetch() {

            // Await operator is used to wait for a promise. 
            // An await can cause an async function to pause until a Promise is settled.
            let response;
            response = await fetch('assets/Seattle_bus_stops.geojson');
            busStops = await response.json();



            //load data to the map as new layers.
            //map.on('load', function loadingData() {
            map.on('load', () => { //simplifying the function statement: arrow with brackets to define a function

                // when loading a geojson, there are two steps
                // add a source of the data and then add the layer out of the source
                map.addSource('bus-stops', {
                    type: 'geojson',
                    data: busStops,
                    // added cluster points
                    cluster: true,
                    clusterMaxZoom: 14,
                    clusterRadius: 50
                });

                // Add clustered points layer
                map.addLayer({
                    'id': 'bus-stops-cluster',
                    'type': 'circle',
                    'source': 'bus-stops',
                    'filter': ['has', 'point_count'],
                    'paint': {
                        'circle-color': [
                            'step',
                            ['get', 'point_count'],
                            colors[0],
                            grades[0], colors[1],
                            grades[1], colors[2],
                            grades[2], colors[3],
                            grades[3], colors[4]
                        ],
                        'circle-radius': [
                            'step',
                            ['get', 'point_count'],
                            radii[0],
                            grades[0], radii[1],
                            grades[1], radii[2],
                            grades[2], radii[3],
                            grades[3], radii[4]
                        ],
                        'circle-stroke-color': 'white',
                        'circle-stroke-width': 1,
                        'circle-opacity': 0.8
                    }
                });

                // Add unclustered point layer
                map.addLayer({
                    'id': 'bus-stops-unclustered',
                    'type': 'circle',
                    'source': 'bus-stops',
                    'filter': ['!', ['has', 'point_count']],
                    'paint': {
                        'circle-color': 'rgb(240,200,0)',
                        'circle-radius': 5,
                        'circle-stroke-color': 'white',
                        'circle-stroke-width': 1,
                        'circle-opacity': 0.8
                    }
                });

                // Add cluster count label layer
                map.addLayer({
                    'id': 'bus-stops-cluster-count',
                    'type': 'symbol',
                    'source': 'bus-stops',
                    'filter': ['has', 'point_count'],
                    'layout': {
                        'text-field': '{point_count_abbreviated}',
                        'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
                        'text-size': 12
                    },
                    'paint': {
                        'text-color': 'white'
                    }
                });

                map.on('click', 'bus-stops-cluster', (event) => {
                    let props = event.features[0].properties;
                    let html = '<strong>Cluster</strong><br>';
                    html += `<strong>Point Count:</strong> ${props.point_count}<br>`;
                    new mapboxgl.Popup()
                        .setLngLat(event.features[0].geometry.coordinates)
                        .setHTML(html)
                        .addTo(map);
                });

                map.on('click', 'bus-stops-unclustered', (event) => {
                    let props = event.features[0].properties;
                    let html = '<strong>Bus Stop</strong><br>';
                    if (props.STOP_ID) {
                        html += `<strong>STOP_ID:</strong> ${props.STOP_ID}<br>`;
                    }
                    if (props.BEARING_CODE) {
                        html += `<strong>BEARING_CODE:</strong> ${props.BEARING_CODE}<br>`;
                    }
                    new mapboxgl.Popup()
                        .setLngLat(event.features[0].geometry.coordinates)
                        .setHTML(html)
                        .addTo(map);
                });


                // count bus stops in the displayed map view
                let clusterSizes = calBusStops(busStops, map.getBounds());

                // get the total number of bus stops
                numBusStops = clusterSizes.total;

                // update the content of the element bus-count.
                document.getElementById("bus-count").innerHTML = numBusStops;

                // calculate and display bearing code chart
                let bearingCounts = calBearingCounts(busStops, map.getBounds());
                let columns = Object.keys(bearingCounts).map(key => [key, bearingCounts[key]]);

                if (!bearingChart) {
                    bearingChart = c3.generate({
                        bindto: '#bearing-chart',
                        data: {
                            columns: columns,
                            type: 'pie'
                        },
                        legend: {
                            position: 'right'
                        }
                    });
                } else {
                    bearingChart.load({
                        columns: columns
                    });
                }
            });



            //load data to the map as new layers.
            map.on('idle', () => {

                let clusterSizes = calBusStops(busStops, map.getBounds());
                numBusStops = clusterSizes.total;
                document.getElementById("bus-count").innerHTML = numBusStops;

                let bearingCounts = calBearingCounts(busStops, map.getBounds());
                let columns = Object.keys(bearingCounts).map(key => [key, bearingCounts[key]]);

                bearingChart.load({
                    columns: columns
                });
            });
        }

        // call the geojson loading function
        geojsonFetch();

        function calBusStops(currentBusStops, currentMapBounds) {
            let totalCount = 0;
            let clusterSizesClasses = {
                '1000+': 0,
                500: 0,
                250: 0,
                '50-100': 0,
                '50 or less': 0
            };
            
            currentBusStops.features.forEach(function (d) { 
                if (currentMapBounds.contains(d.geometry.coordinates)) {
                    totalCount += 1;
                }
            });
            
            let remaining = totalCount;
            clusterSizesClasses['1000+'] = Math.floor(remaining / 1000);
            remaining = remaining % 1000;
            clusterSizesClasses[500] = Math.floor(remaining / 500);
            remaining = remaining % 500;
            clusterSizesClasses[250] = Math.floor(remaining / 250);
            remaining = remaining % 250;
            clusterSizesClasses['50-100'] = Math.floor(remaining / 100);
            remaining = remaining % 100;
            clusterSizesClasses['50 or less'] = remaining;
            
            // Store total for display
            clusterSizesClasses.total = totalCount;
            return clusterSizesClasses;
        }

        function calBearingCounts(currentBusStops, currentMapBounds) {
            let counts = {};

            currentBusStops.features.forEach(function (d) {
                if (currentMapBounds.contains(d.geometry.coordinates)) {
                    let code = d.properties.BEARING_CODE || 'Unknown';
                    counts[code] = (counts[code] || 0) + 1;
                }
            });

            return counts;
        }

        // capture the element reset and add a click event to it.
        const reset = document.getElementById('reset');
        reset.addEventListener('click', event => {

            // this event will trigger the map fly to its origin location and zoom level.
            map.flyTo({
                zoom: 12,
                center: [-122.3321, 47.6062]
            });

        });
    </script>
</body>

</html>
